{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Checkout" %} | Despair Chinese{% endblock %}

{% block content %}
<div class="page-header page-header-sm">
    <div class="container">
        <h1 class="page-header-title">{% trans "Checkout" %}</h1>
        <!-- Steps indicator -->
        <div class="checkout-steps">
            <div class="step step-done"><i class="fas fa-check"></i> {% trans "Basket" %}</div>
            <div class="step step-active">{% trans "Details" %}</div>
            <div class="step">{% trans "Confirmation" %}</div>
        </div>
    </div>
</div>

<div class="container py-5">
    {% if not is_open %}
    <div class="alert alert-warning d-flex align-items-start gap-3 mb-4 rounded-3">
        <i class="fas fa-moon fa-lg mt-1 flex-shrink-0"></i>
        <div>
            <strong>{% trans "We're currently closed" %}</strong><br>
            <span class="small">
                {% if next_open_text %}
                    {% blocktrans with t=next_open_text %}You can still place your order — we'll start preparing it when we open {{ t }}.{% endblocktrans %}
                {% else %}
                    {% trans "You can still place your order and we'll prepare it when we next open." %}
                {% endif %}
            </span>
        </div>
    </div>
    {% endif %}
    <form method="post" id="checkout-form">
        {% csrf_token %}
        <div class="row g-4">

            <!-- LEFT: Form -->
            <div class="col-lg-7">

                <!-- Contact details -->
                <div class="checkout-section">
                    <h5 class="checkout-section-title"><i class="fas fa-user me-2"></i>{% trans "Contact Details" %}</h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">{% trans "Full Name" %} *</label>
                            {{ form.full_name }}
                            {% if form.full_name.errors %}<div class="invalid-feedback d-block">{{ form.full_name.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Email" %} *</label>
                            {{ form.email }}
                            {% if form.email.errors %}<div class="invalid-feedback d-block">{{ form.email.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{% trans "Phone" %} *</label>
                            {{ form.phone }}
                            {% if form.phone.errors %}<div class="invalid-feedback d-block">{{ form.phone.errors|join:", " }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Delivery or Collection -->
                <div class="checkout-section mt-4">
                    <h5 class="checkout-section-title"><i class="fas fa-motorcycle me-2"></i>{% trans "Delivery or Collection?" %}</h5>
                    <div class="delivery-toggle row g-3">
                        <div class="col-6">
                            <label class="delivery-option-card {% if form.delivery_type.value == 'delivery' or not form.delivery_type.value %}active{% endif %}" id="opt-delivery">
                                <input type="radio" name="delivery_type" value="delivery" {% if form.delivery_type.value == 'delivery' or not form.delivery_type.value %}checked{% endif %} class="d-none">
                                <i class="fas fa-motorcycle fa-2x mb-2"></i>
                                <strong>{% trans "Delivery" %}</strong>
                                <span class="small text-muted">{% trans "30–45 min" %}</span>
                                <span class="small">{% trans "£2.50 (free delivery over £20)" %}</span>
                            </label>
                        </div>
                        <div class="col-6">
                            <label class="delivery-option-card {% if form.delivery_type.value == 'collection' %}active{% endif %}" id="opt-collection">
                                <input type="radio" name="delivery_type" value="collection" {% if form.delivery_type.value == 'collection' %}checked{% endif %} class="d-none">
                                <i class="fas fa-store fa-2x mb-2"></i>
                                <strong>{% trans "Collection" %}</strong>
                                <span class="small text-muted">{% trans "~15 min" %}</span>
                                <span class="small text-success">{% trans "Free" %}</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Delivery address (shown only for delivery) -->
                <div class="checkout-section mt-4" id="address-section">
                    <h5 class="checkout-section-title"><i class="fas fa-map-marker-alt me-2"></i>{% trans "Delivery Address" %}</h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">{% trans "Address Line 1" %} *</label>
                            {{ form.address_line1 }}
                            {% if form.address_line1.errors %}<div class="invalid-feedback d-block">{{ form.address_line1.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-12">
                            <label class="form-label">{% trans "Address Line 2" %} <span class="text-muted">({% trans "optional" %})</span></label>
                            {{ form.address_line2 }}
                        </div>
                        <div class="col-md-7">
                            <label class="form-label">{% trans "City" %} *</label>
                            {{ form.city }}
                            {% if form.city.errors %}<div class="invalid-feedback d-block">{{ form.city.errors|join:", " }}</div>{% endif %}
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">{% trans "Postcode" %} *</label>
                            {{ form.postcode }}
                            {% if form.postcode.errors %}<div class="invalid-feedback d-block">{{ form.postcode.errors|join:", " }}</div>{% endif %}
                        </div>
                    </div>
                    {% if user.is_authenticated %}
                    <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" name="save_address" id="save_address" value="1" {% if profile_has_address %}checked{% endif %}>
                        <label class="form-check-label text-muted small" for="save_address">
                            <i class="fas fa-save me-1"></i>{% trans "Save this address to my profile for next time" %}
                        </label>
                    </div>
                    {% endif %}
                </div>

                <!-- Payment method -->
                <div class="checkout-section mt-4">
                    <h5 class="checkout-section-title"><i class="fas fa-credit-card me-2"></i>{% trans "Payment Method" %}</h5>
                    <div class="row g-3" id="payment-options">
                        <div class="col-12 col-md-4" data-payment-mode="both">
                            <label class="payment-option-card">
                                <input type="radio" name="payment_method" value="card" {% if form.payment_method.value == 'card' or not form.payment_method.value %}checked{% endif %} class="d-none payment-radio">
                                <i class="fas fa-credit-card fa-lg mb-1"></i>
                                <span>Card Payment</span>
                            </label>
                        </div>
                        <div class="col-12 col-md-4" data-payment-mode="delivery">
                            <label class="payment-option-card">
                                <input type="radio" name="payment_method" value="cash_delivery" {% if form.payment_method.value == 'cash_delivery' %}checked{% endif %} class="d-none payment-radio">
                                <i class="fas fa-money-bill-wave fa-lg mb-1"></i>
                                <span>Cash on Delivery</span>
                            </label>
                        </div>
                        <div class="col-12 col-md-4" data-payment-mode="collection">
                            <label class="payment-option-card">
                                <input type="radio" name="payment_method" value="cash_collection" {% if form.payment_method.value == 'cash_collection' %}checked{% endif %} class="d-none payment-radio">
                                <i class="fas fa-store fa-lg mb-1"></i>
                                <span>Cash on Collection</span>
                            </label>
                        </div>
                    </div>

                    <!-- Fake card entry fields -->
                    <div id="card-fields" class="mt-3">
                        <div class="card-fields-inner p-3 rounded-3">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">{% trans "Card Number" %}</label>
                                    {{ form.card_number }}
                                </div>
                                <div class="col-6">
                                    <label class="form-label">{% trans "Expiry" %}</label>
                                    {{ form.card_expiry }}
                                </div>
                                <div class="col-6">
                                    <label class="form-label">CVV</label>
                                    {{ form.card_cvv }}
                                </div>
                            </div>
                            <p class="text-muted small mt-2 mb-0"><i class="fas fa-lock me-1"></i>{% trans "This is a demo — no real payment is taken." %}</p>
                        </div>
                    </div>
                </div>

                <!-- Special instructions -->
                <div class="checkout-section mt-4">
                    <h5 class="checkout-section-title"><i class="fas fa-comment-dots me-2"></i>{% trans "Special Instructions" %} <span class="text-muted fw-normal">({% trans "optional" %})</span></h5>
                    {{ form.special_instructions }}
                    <div class="text-end mt-1" style="font-size:0.75rem;color:#9a8870;"><span id="si-count">0</span>/500</div>
                </div>

            </div>

            <!-- RIGHT: Order summary -->
            <div class="col-lg-5">
                <div class="order-summary-card sticky-top" style="top: 90px;"
                     data-subtotal="{{ basket.get_subtotal }}"
                     data-delivery-charge="{{ delivery_charge }}"
                     data-free-threshold="20"
                     data-min-order="{{ min_order_delivery }}">
                    <h5 class="mb-4">{% trans "Your Order" %}</h5>
                    {% for item_data in basket %}
                    <div class="summary-line d-flex justify-content-between mb-2">
                        <span>{{ item_data.quantity }}× {{ item_data.menu_item.name }}</span>
                        <span>£{{ item_data.total_price }}</span>
                    </div>
                    {% endfor %}
                    <hr>
                    <div class="summary-row">
                        <span>{% trans "Subtotal" %}</span>
                        <span>£{{ basket.get_subtotal }}</span>
                    </div>
                    <div class="summary-row" id="delivery-summary-row">
                        <span>{% trans "Delivery" %}</span>
                        <span id="delivery-cost">
                            {% if basket.get_subtotal >= 20 %}<span class="text-success">{% trans "Free" %}</span>
                            {% else %}£{{ delivery_charge }}{% endif %}
                        </span>
                    </div>
                    <hr>
                    {% if basket.get_discount %}
                    <div class="summary-row" style="color:var(--gold);">
                        <span><i class="fas fa-tag me-1"></i>
                            {% trans "Discount" %}
                            {% if basket.promo_code %}({{ basket.promo_code }}){% endif %}
                        </span>
                        <span>− £{{ basket.get_discount }}</span>
                    </div>
                    {% endif %}
                    <div class="summary-row summary-total">
                        <span>{% trans "Total" %}</span>
                        <span id="total-cost">£{{ basket.get_total }}</span>
                    </div>
                    {% if min_order_delivery and basket.get_subtotal < min_order_delivery %}
                    <div class="alert alert-warning py-2 px-3 mt-3 mb-0 rounded-3" style="font-size:0.82rem;" id="min-order-warning">
                        <i class="fas fa-info-circle me-1"></i>
                        {% blocktrans with min=min_order_delivery %}Minimum order for delivery is £{{ min }}.{% endblocktrans %}
                    </div>
                    {% endif %}

                    <button type="submit" class="btn btn-primary-custom w-100 mt-4 btn-lg">
                        <i class="fas fa-check me-2"></i>{% trans "Place Order" %}
                    </button>
                    <p class="text-center text-muted small mt-2">
                        <i class="fas fa-shield-alt me-1"></i>{% trans "Your order is safe with us" %}
                    </p>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const deliveryRadios = document.querySelectorAll('input[name="delivery_type"]');
    const paymentRadios = document.querySelectorAll('.payment-radio');
    const addressSection = document.getElementById('address-section');
    const cardFields = document.getElementById('card-fields');
    const cards = document.querySelectorAll('.delivery-option-card');
    const payCards = document.querySelectorAll('.payment-option-card');
    const summaryCard = document.querySelector('[data-subtotal]');

    // Delivery/Collection toggle
    function updateDelivery() {
        const chosen = document.querySelector('input[name="delivery_type"]:checked').value;
        addressSection.style.display = chosen === 'delivery' ? 'block' : 'none';
        cards.forEach(c => c.classList.remove('active'));
        document.querySelector(`input[name="delivery_type"][value="${chosen}"]`).closest('.delivery-option-card').classList.add('active');

        // Show/hide payment options — cash on delivery only for delivery, cash on collection only for collection
        document.querySelectorAll('#payment-options [data-payment-mode]').forEach(col => {
            const mode = col.dataset.paymentMode;
            const visible = mode === 'both' || mode === chosen;
            col.style.display = visible ? '' : 'none';
            // If the hidden option was selected, auto-switch to card
            if (!visible && col.querySelector('.payment-radio:checked')) {
                document.querySelector('.payment-radio[value="card"]').checked = true;
                updatePayment();
            }
        });

        // Recalculate delivery charge & total live
        if (summaryCard) {
            const subtotal    = parseFloat(summaryCard.dataset.subtotal) || 0;
            const charge      = parseFloat(summaryCard.dataset.deliveryCharge) || 0;
            const threshold   = parseFloat(summaryCard.dataset.freeThreshold) || 20;
            const minOrder    = parseFloat(summaryCard.dataset.minOrder) || 0;
            const delivCostEl = document.getElementById('delivery-cost');
            const totalEl     = document.getElementById('total-cost');
            const minWarning  = document.getElementById('min-order-warning');

            let deliveryFee = 0;
            if (chosen === 'delivery') {
                deliveryFee = subtotal >= threshold ? 0 : charge;
                if (delivCostEl) {
                    delivCostEl.innerHTML = deliveryFee === 0
                        ? '<span class="text-success">Free</span>'
                        : `£${deliveryFee.toFixed(2)}`;
                }
                // Show/hide min order warning
                if (minWarning) {
                    minWarning.style.display = (subtotal < minOrder) ? 'block' : 'none';
                }
            } else {
                // Collection — always free
                if (delivCostEl) delivCostEl.innerHTML = '<span class="text-success">Free</span>';
                if (minWarning) minWarning.style.display = 'none';
            }
            if (totalEl) totalEl.textContent = `£${(subtotal + deliveryFee).toFixed(2)}`;
        }
    }
    deliveryRadios.forEach(r => r.addEventListener('change', updateDelivery));
    updateDelivery();

    // Payment method toggle
    function updatePayment() {
        const chosen = document.querySelector('.payment-radio:checked').value;
        cardFields.style.display = chosen === 'card' ? 'block' : 'none';
        payCards.forEach(c => c.classList.remove('active'));
        document.querySelector(`.payment-radio[value="${chosen}"]`).closest('.payment-option-card').classList.add('active');
    }
    paymentRadios.forEach(r => r.addEventListener('change', updatePayment));
    updatePayment();

    // Card number formatting (add spaces every 4 digits)
    const cardInput = document.querySelector('input[name="card_number"]');
    if (cardInput) {
        cardInput.addEventListener('input', function() {
            let val = this.value.replace(/\D/g, '').substring(0, 16);
            this.value = val.replace(/(.{4})/g, '$1 ').trim();
        });
    }

    // Expiry auto-format MM/YY
    const expiryInput = document.querySelector('input[name="card_expiry"]');
    if (expiryInput) {
        expiryInput.setAttribute('placeholder', 'MM/YY');
        expiryInput.addEventListener('input', function() {
            let val = this.value.replace(/\D/g, '').substring(0, 4);
            if (val.length >= 3) val = val.substring(0, 2) + '/' + val.substring(2);
            this.value = val;
        });
    }

    // CVV — digits only, exactly 3
    const cvvInput = document.querySelector('input[name="card_cvv"]');
    if (cvvInput) {
        cvvInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 3);
        });
    }

    // Card field validation on submit
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            const payMethod = document.querySelector('.payment-radio:checked');
            if (!payMethod || payMethod.value !== 'card') return;
            const exp = expiryInput ? expiryInput.value : '';
            if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(exp)) {
                e.preventDefault();
                if (expiryInput) { expiryInput.focus(); expiryInput.style.outline = '2px solid var(--red)'; }
                return;
            }
            if (cvvInput && cvvInput.value.length !== 3) {
                e.preventDefault();
                cvvInput.focus();
                cvvInput.style.outline = '2px solid var(--red)';
            }
        });
    }

    // Special instructions character counter
    const siField = document.querySelector('textarea[name="special_instructions"]');
    const siCount = document.getElementById('si-count');
    if (siField && siCount) {
        siField.setAttribute('maxlength', '500');
        const updateCount = () => { siCount.textContent = siField.value.length; };
        siField.addEventListener('input', updateCount);
        updateCount();
    }
</script>
{% endblock %}
