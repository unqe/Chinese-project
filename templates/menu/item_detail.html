{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ item.name }} | Despair Chinese{% endblock %}

{% block content %}
<div class="page-header page-header-sm">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "Home" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'menu:menu' %}">{% trans "Menu" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'menu:menu' %}?category={{ item.category.pk }}">{{ item.category.name }}</a></li>
                <li class="breadcrumb-item active">{{ item.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container py-5">
    <div class="row g-5 align-items-start">
        <!-- Image -->
        <div class="col-lg-5">
            <div class="position-relative detail-img-wrap">
                {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.name }}" class="detail-img rounded-3 w-100" id="detail-hero-img" loading="eager" fetchpriority="high">
                {% else %}
                    <div class="detail-img-placeholder rounded-3" id="detail-img-placeholder">
                        <i class="fas fa-bowl-food fa-5x"></i>
                    </div>
                {% endif %}
                {% if user.is_staff %}
                <button class="staff-img-edit-btn staff-img-edit-btn--detail" type="button"
                        data-item-id="{{ item.pk }}"
                        data-item-name="{{ item.name }}"
                        data-update-url="{% url 'menu:staff_update_image' item.pk %}"
                        data-has-image="{% if item.image %}1{% else %}0{% endif %}"
                        aria-label="{% trans 'Edit image for' %} {{ item.name }}">
                    <i class="fas fa-camera me-1"></i> {% trans "Edit Image" %}
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Details -->
        <div class="col-lg-7">
            <span class="detail-category">{{ item.category.name }}</span>
            <h1 class="detail-title mt-2">{{ item.name }}</h1>

            <!-- Tags row -->
            <div class="d-flex flex-wrap gap-2 mb-3">
                {% if item.is_popular %}<span class="badge-popular">‚≠ê {% trans "Popular" %}</span>{% endif %}
                {% if item.is_vegetarian %}<span class="badge-veg">üåø {% trans "Vegetarian" %}</span>{% endif %}
                {% if item.is_vegan %}<span class="badge-vegan">üå± {% trans "Vegan" %}</span>{% endif %}
                {% if item.spice_level > 0 %}
                    <span class="badge-spice">{% for _ in item.spice_icons %}üå∂{% endfor %} {{ item.get_spice_level_display }}</span>
                {% endif %}
            </div>

            <div class="detail-price">¬£{{ item.price }}</div>

            {% if item.description %}
                <p class="detail-description mt-3">{{ item.description }}</p>
            {% endif %}

            {% if item.allergens %}
                <div class="allergens-notice mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>{% trans "Allergens:" %}</strong> {{ item.allergens }}
                </div>
            {% endif %}

            <!-- Add to basket -->
            {% if is_deal %}
            <div class="add-form mt-4">
                <a href="{% url 'orders:deal_picker' item.pk %}" class="btn btn-hero-primary btn-lg w-100">
                    <i class="fas fa-list-ul me-2"></i>{% trans "Choose Your Items" %}
                </a>
                <p class="text-muted small mt-2"><i class="fas fa-info-circle me-1"></i>{% trans "This is a set deal ‚Äî tap above to pick your selections." %}</p>
            </div>
            {% else %}
            <form action="{% url 'orders:basket_add' item.pk %}" method="post" class="add-form mt-4" id="detail-add-form">
                {% csrf_token %}
                <div class="qty-row d-flex align-items-center gap-3">
                    <div class="qty-control d-flex align-items-center">
                        <button type="button" class="qty-btn" id="qty-minus" aria-label="{% trans 'Decrease quantity' %}">‚àí</button>
                        <input type="number" name="quantity" id="qty-input" value="1" min="1" max="20" class="qty-input">
                        <button type="button" class="qty-btn" id="qty-plus" aria-label="{% trans 'Increase quantity' %}">+</button>
                    </div>
                    <button type="submit" class="btn btn-hero-primary flex-grow-1">
                        <i class="fas fa-shopping-bag me-2"></i>{% trans "Add to Basket" %}
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Related items -->
    {% if related_items %}
    <div class="mt-5 pt-4">
        <h2 class="section-title mb-4">{% trans "More from" %} {{ item.category.name }}</h2>
        <div class="row g-3">
            {% for rel in related_items %}
            <div class="col-sm-6 col-lg-3">
                <div class="menu-card h-100">
                    <div class="menu-card-img-wrap">
                        {% if rel.image %}
                            <img src="{{ rel.image.url }}" alt="{{ rel.name }}" class="menu-card-img" loading="lazy">
                        {% else %}
                            <div class="menu-card-img-placeholder"><i class="fas fa-bowl-food"></i></div>
                        {% endif %}
                    </div>
                    <div class="menu-card-body">
                        <h5 class="menu-card-title">
                            <a href="{% url 'menu:item_detail' rel.pk %}" class="stretched-link-title">{{ rel.name }}</a>
                        </h5>
                        <div class="menu-card-footer">
                            <span class="menu-card-price">¬£{{ rel.price }}</span>
                            <form action="{% url 'orders:basket_add' rel.pk %}" method="post" class="rel-add-form">
                                {% csrf_token %}
                                <input type="hidden" name="quantity" value="1">
                                <button type="submit" class="btn btn-add-to-basket" aria-label="{% trans 'Add' %} {{ rel.name }}"><i class="fas fa-plus"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    const CSRF_DETAIL = '{{ csrf_token }}';
    const qtyInput = document.getElementById('qty-input');
    document.getElementById('qty-minus').addEventListener('click', () => {
        if (qtyInput.value > 1) qtyInput.value = parseInt(qtyInput.value) - 1;
    });
    document.getElementById('qty-plus').addEventListener('click', () => {
        if (qtyInput.value < 20) qtyInput.value = parseInt(qtyInput.value) + 1;
    });

    function showToast(msg) {
        showSiteAlert(msg, 'success');
    }

    function updateNavBasketDetail(count, subtotal) {
        const navLink = document.querySelector('a.btn-basket');
        if (!navLink) return;
        let badge = navLink.querySelector('.basket-badge');
        let price = navLink.querySelector('.basket-price');
        if (count > 0) {
            if (!badge) { badge = document.createElement('span'); badge.className = 'basket-badge'; navLink.appendChild(badge); }
            badge.textContent = count;
            if (!price) { price = document.createElement('span'); price.className = 'basket-price'; navLink.appendChild(price); }
            price.textContent = '\u00a3' + parseFloat(subtotal).toFixed(2);
        } else {
            if (badge) badge.remove();
            if (price) price.remove();
        }
    }

    function ajaxAddDetail(form) {
        const data = new URLSearchParams(new FormData(form));
        fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': CSRF_DETAIL, 'X-Requested-With': 'XMLHttpRequest' },
            body: data,
        }).then(r => r.json()).then(d => {
            if (d.success) {
                showToast(d.message || 'Added to basket');
                updateNavBasketDetail(d.basket_count, d.basket_subtotal);
            }
        }).catch(console.error);
    }

    // Main add form
    const mainForm = document.getElementById('detail-add-form');
    if (mainForm) {
        mainForm.addEventListener('submit', function(e) {
            e.preventDefault();
            ajaxAddDetail(this);
        });
    }

    // Related item add forms
    document.querySelectorAll('.rel-add-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            ajaxAddDetail(this);
        });
    });
</script>
{% endblock %}
